# ClipPal è½»é‡çº§æ¸è¿›å¼é‡æ„æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: v1.0
- **æ—¥æœŸ**: 2025-12-02
- **ä½œè€…**: ClipPal Team
- **çŠ¶æ€**: å¾…è¯„å®¡

---

## ç›®å½•
- [ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°](#ä¸€æ–¹æ¡ˆæ¦‚è¿°)
- [äºŒã€ç°çŠ¶åˆ†æ](#äºŒç°çŠ¶åˆ†æ)
- [ä¸‰ã€ç›®æ ‡æ¶æ„](#ä¸‰ç›®æ ‡æ¶æ„)
- [å››ã€æ ¸å¿ƒæ”¹è¿›ç‚¹](#å››æ ¸å¿ƒæ”¹è¿›ç‚¹)
- [äº”ã€è¯¦ç»†è®¾è®¡](#äº”è¯¦ç»†è®¾è®¡)
- [å…­ã€å®æ–½è·¯çº¿å›¾](#å…­å®æ–½è·¯çº¿å›¾)
- [ä¸ƒã€æ–¹æ¡ˆå¯¹æ¯”](#ä¸ƒæ–¹æ¡ˆå¯¹æ¯”)
- [å…«ã€é£é™©ä¸åº”å¯¹](#å…«é£é™©ä¸åº”å¯¹)

---

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 è®¾è®¡ç†å¿µ

æœ¬æ–¹æ¡ˆé‡‡ç”¨**è½»é‡çº§æ¸è¿›å¼é‡æ„**ç­–ç•¥ï¼Œåœ¨ä¸å¼•å…¥è¿‡åº¦å¤æ‚æ€§çš„å‰æä¸‹ï¼Œè§£å†³å½“å‰æ¶æ„çš„æ ¸å¿ƒé—®é¢˜ã€‚

**æ ¸å¿ƒåŸåˆ™ï¼š**
- ğŸ¯ **èšç„¦é—®é¢˜** - åªè§£å†³çœŸæ­£å­˜åœ¨çš„é—®é¢˜
- ğŸ“¦ **ç®€å•ä¼˜å…ˆ** - é¿å…è¿‡åº¦è®¾è®¡
- ğŸ”„ **æ¸è¿›è¿­ä»£** - åˆ†é˜¶æ®µå®æ–½ï¼Œä¿æŒç³»ç»Ÿå¯è¿è¡Œ
- ğŸ’° **æˆæœ¬å¯æ§** - ä»£ç é‡å¢åŠ æ§åˆ¶åœ¨30%ä»¥å†…

### 1.2 ä¸ºä»€ä¹ˆä¸ç”¨å®Œæ•´DDDï¼Ÿ

| è€ƒè™‘å› ç´  | å®Œæ•´DDD | æœ¬æ–¹æ¡ˆ |
|---------|---------|--------|
| **é¡¹ç›®è§„æ¨¡** | é€‚åˆå¤§å‹ç³»ç»Ÿ | âœ… é€‚åˆä¸­å°å‹ç³»ç»Ÿ |
| **å›¢é˜Ÿè§„æ¨¡** | éœ€è¦10+å¼€å‘è€… | âœ… é€‚åˆå°å›¢é˜Ÿ/ä¸ªäºº |
| **é¢†åŸŸå¤æ‚åº¦** | éœ€è¦å¤æ‚ä¸šåŠ¡è§„åˆ™ | âœ… ä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å• |
| **å¼€å‘å‘¨æœŸ** | 1-2ä¸ªæœˆ | âœ… 2-3å‘¨ |
| **ä»£ç å¢é‡** | +70% | âœ… +30% |
| **å­¦ä¹ æ›²çº¿** | é™¡å³­ | âœ… å¹³ç¼“ |

### 1.3 æ–¹æ¡ˆæ”¶ç›Š

| æ”¹è¿›é¡¹ | å½“å‰çŠ¶æ€ | æ”¹è¿›å |
|--------|---------|--------|
| **å®ä½“å°è£…** | è´«è¡€æ¨¡å‹ï¼Œæ‰€æœ‰å­—æ®µpublic | å……è¡€æ¨¡å‹ï¼Œç§æœ‰å­—æ®µ+è¡Œä¸ºæ–¹æ³• |
| **æ•°æ®è®¿é—®** | ä¸šåŠ¡å±‚ç›´æ¥ä½¿ç”¨RBatis | Repositoryå±‚éš”ç¦» |
| **ä¾èµ–ç®¡ç†** | å…¨å±€CONTEXTï¼Œ73å¤„å¼•ç”¨ | ä¾èµ–æ³¨å…¥ï¼Œæ˜ç¡®ä¾èµ–å…³ç³» |
| **ä¸šåŠ¡é€»è¾‘** | æ•£è½åœ¨é™æ€æ–¹æ³•ä¸­ | é›†ä¸­åœ¨Serviceå±‚ |
| **å¯æµ‹è¯•æ€§** | éš¾ä»¥Mockå’Œå•å…ƒæµ‹è¯• | æ˜“äºæµ‹è¯•ï¼Œå¯Mockä¾èµ– |
| **æ¨¡å—è€¦åˆ** | é«˜è€¦åˆï¼Œå•æ–‡ä»¶ä¾èµ–10+æ¨¡å— | ä½è€¦åˆï¼Œæ¸…æ™°çš„åˆ†å±‚ |

---

## äºŒã€ç°çŠ¶åˆ†æ

### 2.1 å½“å‰æ¶æ„é—®é¢˜

#### é—®é¢˜1ï¼šè´«è¡€é¢†åŸŸæ¨¡å‹ï¼ˆæœ€ä¸¥é‡ï¼‰

**å½“å‰ä»£ç ï¼š** `src-tauri/src/biz/clip_record.rs`

```rust
// âŒ é—®é¢˜ä»£ç 
#[derive(Clone, Debug, Serialize, Deserialize, Default)]
pub struct ClipRecord {
    pub id: String,              // âŒ æ‰€æœ‰å­—æ®µpublic
    pub r#type: String,          // âŒ ä½¿ç”¨Stringè€Œéæšä¸¾
    pub content: Value,
    pub md5_str: String,
    pub created: u64,            // âŒ ä½¿ç”¨åŸå§‹ç±»å‹
    pub pinned_flag: i32,        // âŒ å‘½åä¸æ¸…æ™°
    pub sync_flag: Option<i32>,  // âŒ åº”è¯¥ç”¨æšä¸¾
    // ... æ›´å¤šå­—æ®µ
}

impl ClipRecord {
    // âŒ å…¨æ˜¯é™æ€æ–¹æ³•ï¼Œéœ€è¦ä¼ RBatis
    pub async fn update_pinned(rb: &RBatis, id: &str, pinned_flag: i32) -> AppResult<()> {
        // ...
    }

    pub async fn update_content(rb: &RBatis, id: &str, content: &str) -> AppResult<()> {
        // ...
    }

    // ... 20+ä¸ªé™æ€æ–¹æ³•
}
```

**é—®é¢˜æ€»ç»“ï¼š**
- å®ä½“åªæ˜¯æ•°æ®å®¹å™¨ï¼Œæ²¡æœ‰è¡Œä¸º
- æ‰€æœ‰å­—æ®µpublicï¼Œç ´åå°è£…
- ä¸šåŠ¡é€»è¾‘åœ¨é™æ€æ–¹æ³•ä¸­ï¼Œéœ€è¦ä¼ RBatis
- éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•

#### é—®é¢˜2ï¼šå…¨å±€çŠ¶æ€æ³›æ»¥

**å½“å‰ä»£ç ï¼š** å¤šä¸ªæ–‡ä»¶

```rust
// âŒ CONTEXTåœ¨20ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œå…±73å¤„å¼•ç”¨
pub static CONTEXT: TypeMap![Send + Sync] = <TypeMap![Send + Sync]>::new();

// ä½¿ç”¨ç¤ºä¾‹ï¼ˆåˆ°å¤„éƒ½æ˜¯ï¼‰
let rb: &RBatis = CONTEXT.get::<RBatis>();
let app_handle = CONTEXT.get::<AppHandle>();
let settings = CONTEXT.get::<Settings>();
```

**é—®é¢˜æ€»ç»“ï¼š**
- éšå¼ä¾èµ–ï¼Œéš¾ä»¥è¿½è¸ª
- å¹¶å‘å®‰å…¨é—®é¢˜ï¼ˆéœ€è¦å¤§é‡é”ï¼‰
- éš¾ä»¥å•å…ƒæµ‹è¯•
- å…¨å±€çŠ¶æ€ç«äº‰

#### é—®é¢˜3ï¼šæ•°æ®è®¿é—®æ··ä¹±

**å½“å‰ä»£ç ï¼š** ä¸šåŠ¡å±‚ç›´æ¥ä½¿ç”¨RBatis

```rust
// âŒ ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®è®¿é—®æ··åˆ
pub async fn sync_clipboard() -> AppResult<()> {
    let rb: &RBatis = CONTEXT.get::<RBatis>();

    // ç›´æ¥æ‰§è¡ŒSQL
    let records = ClipRecord::select_all(rb).await?;

    // ä¸šåŠ¡é€»è¾‘
    for record in records {
        // ...
    }
}
```

**é—®é¢˜æ€»ç»“ï¼š**
- æ²¡æœ‰RepositoryæŠ½è±¡å±‚
- ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®è®¿é—®è€¦åˆ
- éš¾ä»¥æµ‹è¯•å’ŒMock

#### é—®é¢˜4ï¼šæ¨¡å—é«˜è€¦åˆ

**å½“å‰ä»£ç ï¼š** `src-tauri/src/biz/cloud_sync_timer.rs`

```rust
// âŒ å•ä¸ªæ–‡ä»¶ä¾èµ–10+ä¸ªæ¨¡å—
use crate::api::cloud_sync_api::{...};
use crate::biz::clip_record::{...};
use crate::biz::clip_record_clean::try_clean_clip_record;
use crate::biz::content_search::add_content_to_index;
use crate::biz::sync_time::SyncTime;
use crate::biz::system_setting::{...};
use crate::biz::vip_checker::VipChecker;
use crate::utils::config::get_max_file_size_bytes;
use crate::utils::device_info::GLOBAL_DEVICE_ID;
use crate::utils::file_dir::get_resources_dir;
use crate::utils::lock_utils::{...};
use crate::utils::token_manager::has_valid_auth;
use crate::CONTEXT;
```

### 2.2 ä¸ºä»€ä¹ˆè¿™äº›é—®é¢˜éœ€è¦è§£å†³ï¼Ÿ

| é—®é¢˜ | å½“å‰å½±å“ | æœªæ¥é£é™© |
|-----|---------|---------|
| **è´«è¡€æ¨¡å‹** | ä¸šåŠ¡é€»è¾‘åˆ†æ•£ï¼Œéš¾ä»¥ç†è§£ | éšç€åŠŸèƒ½å¢åŠ ï¼Œä»£ç ä¼šè¶Šæ¥è¶Šæ··ä¹± |
| **å…¨å±€çŠ¶æ€** | å¹¶å‘é—®é¢˜ï¼Œéš¾ä»¥æµ‹è¯• | å®¹æ˜“å‡ºç°éš¾ä»¥è°ƒè¯•çš„bug |
| **æ•°æ®è®¿é—®æ··ä¹±** | ä¸šåŠ¡é€»è¾‘ä¸æŠ€æœ¯ç»†èŠ‚æ··åˆ | æ— æ³•åˆ‡æ¢æ•°æ®åº“æˆ–Mockæµ‹è¯• |
| **é«˜è€¦åˆ** | ä¿®æ”¹ä¸€å¤„å½±å“å¤šå¤„ | æŠ€æœ¯å€ºç´¯ç§¯ï¼Œç»´æŠ¤æˆæœ¬æš´å¢ |

---

## ä¸‰ã€ç›®æ ‡æ¶æ„

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Commands å±‚ï¼ˆTauriæ¥å£ï¼‰              â”‚
â”‚  - clipboard_commands.rs                        â”‚
â”‚  - user_commands.rs                             â”‚
â”‚  - sync_commands.rs                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Services å±‚ï¼ˆä¸šåŠ¡æœåŠ¡ï¼‰              â”‚
â”‚  - ClipboardService                             â”‚
â”‚  - SyncService                                  â”‚
â”‚  - UserService                                  â”‚
â”‚  - VipService                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Repositories å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰           â”‚
â”‚  - ClipboardRepository                          â”‚
â”‚  - UserRepository                               â”‚
â”‚  - SettingsRepository                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Domain å±‚ï¼ˆé¢†åŸŸæ¨¡å‹ï¼‰                â”‚
â”‚  - ClipRecord (å……è¡€æ¨¡å‹)                         â”‚
â”‚  - User                                         â”‚
â”‚  - VipMembership                                â”‚
â”‚  - ç®€å•å€¼å¯¹è±¡ï¼ˆæšä¸¾ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–è§„åˆ™ï¼š**
- Commands â†’ Services â†’ Repositories â†’ Domain
- ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸ä¾èµ–ä¸Šå±‚
- Domainå±‚ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨åº“ï¼ˆé™¤åŸºç¡€ç±»å‹ï¼‰

### 3.2 ç›®å½•ç»“æ„

```
src-tauri/src/
â”œâ”€â”€ main.rs                     # ç¨‹åºå…¥å£
â”œâ”€â”€ lib.rs                      # å¯åŠ¨é…ç½® + ä¾èµ–æ³¨å…¥
â”‚
â”œâ”€â”€ domain/                     # é¢†åŸŸæ¨¡å‹ï¼ˆè½»é‡çº§ï¼‰
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ clipboard.rs            # ClipRecordå®ä½“ï¼ˆå……è¡€æ¨¡å‹ï¼‰
â”‚   â”œâ”€â”€ user.rs                 # Userå®ä½“
â”‚   â”œâ”€â”€ vip.rs                  # VipMembershipå®ä½“
â”‚   â””â”€â”€ types.rs                # é€šç”¨ç±»å‹å’Œç®€å•å€¼å¯¹è±¡
â”‚
â”œâ”€â”€ repository/                 # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ clipboard_repo.rs       # å‰ªè´´æ¿æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ user_repo.rs            # ç”¨æˆ·æ•°æ®è®¿é—®
â”‚   â””â”€â”€ settings_repo.rs        # è®¾ç½®æ•°æ®è®¿é—®
â”‚
â”œâ”€â”€ service/                    # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ clipboard_service.rs    # å‰ªè´´æ¿ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ sync_service.rs         # åŒæ­¥ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ user_service.rs         # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ vip_service.rs          # VIPä¸šåŠ¡é€»è¾‘
â”‚
â”œâ”€â”€ commands/                   # Tauriå‘½ä»¤å±‚
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ clipboard.rs            # å‰ªè´´æ¿å‘½ä»¤
â”‚   â”œâ”€â”€ user.rs                 # ç”¨æˆ·å‘½ä»¤
â”‚   â”œâ”€â”€ sync.rs                 # åŒæ­¥å‘½ä»¤
â”‚   â””â”€â”€ settings.rs             # è®¾ç½®å‘½ä»¤
â”‚
â”œâ”€â”€ api/                        # å¤–éƒ¨APIå®¢æˆ·ç«¯ï¼ˆä¿æŒä¸å˜ï¼‰
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ user_auth_api.rs
â”‚   â”œâ”€â”€ cloud_sync_api.rs
â”‚   â””â”€â”€ vip_api.rs
â”‚
â”œâ”€â”€ platform/                   # å¹³å°å±‚ï¼ˆä¿æŒä¸å˜ï¼‰
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ window.rs
â”‚   â”œâ”€â”€ tray.rs
â”‚   â”œâ”€â”€ menu.rs
â”‚   â””â”€â”€ shortcuts.rs
â”‚
â”œâ”€â”€ infrastructure/             # åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ database.rs             # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ http_client.rs          # HTTPå®¢æˆ·ç«¯
â”‚   â””â”€â”€ storage.rs              # æ–‡ä»¶å­˜å‚¨
â”‚
â”œâ”€â”€ shared/                     # å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ errors.rs               # ç»Ÿä¸€é”™è¯¯ç±»å‹
â”‚   â”œâ”€â”€ config.rs               # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ utils.rs                # é€šç”¨å·¥å…·
â”‚
â””â”€â”€ legacy/                     # å¾…è¿ç§»çš„æ—§ä»£ç 
    â””â”€â”€ biz/                    # é€æ­¥è¿ç§»
```

**å…³é”®å˜åŒ–ï¼š**
- âœ… æ–°å¢ `domain/` - é¢†åŸŸæ¨¡å‹ï¼ˆè½»é‡çº§ï¼‰
- âœ… æ–°å¢ `repository/` - æ•°æ®è®¿é—®å±‚
- âœ… æ–°å¢ `service/` - ä¸šåŠ¡æœåŠ¡å±‚
- âœ… æ–°å¢ `commands/` - Tauriå‘½ä»¤å±‚
- âœ… ä¿ç•™ `api/` - å¤–éƒ¨APIä¸å˜
- âœ… ä¿ç•™ `platform/` - å¹³å°å±‚ä¸å˜
- âœ… é‡æ„ `infrastructure/` - æŠ€æœ¯å®ç°
- âœ… `biz/` â†’ `legacy/` - é€æ­¥è¿ç§»

---

## å››ã€æ ¸å¿ƒæ”¹è¿›ç‚¹

### 4.1 æ”¹è¿›ç‚¹1ï¼šå……è¡€é¢†åŸŸæ¨¡å‹

#### Beforeï¼ˆè´«è¡€æ¨¡å‹ï¼‰

```rust
// âŒ å½“å‰ï¼šè´«è¡€æ¨¡å‹
pub struct ClipRecord {
    pub id: String,
    pub r#type: String,
    pub content: Value,
    pub pinned_flag: i32,
    pub sync_flag: Option<i32>,
    // ...
}

impl ClipRecord {
    // é™æ€æ–¹æ³•ï¼Œéœ€è¦ä¼ RBatis
    pub async fn update_pinned(rb: &RBatis, id: &str, flag: i32) -> AppResult<()> {
        // ...
    }
}

// ä½¿ç”¨æ–¹å¼ï¼šä¸šåŠ¡é€»è¾‘åœ¨å¤–éƒ¨
let rb = CONTEXT.get::<RBatis>();
ClipRecord::update_pinned(rb, "123", 1).await?;
```

#### Afterï¼ˆå……è¡€æ¨¡å‹ï¼‰

```rust
// âœ… æ”¹è¿›åï¼šå……è¡€æ¨¡å‹
use chrono::{DateTime, Local};

pub struct ClipRecord {
    // ç§æœ‰å­—æ®µï¼Œä¿æŠ¤å†…éƒ¨çŠ¶æ€
    id: String,
    content_type: ContentType,       // ä½¿ç”¨æšä¸¾
    content: String,
    md5: String,
    local_file_path: Option<PathBuf>,
    created_at: DateTime<Local>,     // ä½¿ç”¨å¼ºç±»å‹
    updated_at: DateTime<Local>,
    sort: i32,
    is_pinned: bool,                 // æ›´å¥½çš„å‘½å
    sync_status: SyncStatus,         // ä½¿ç”¨æšä¸¾
    device_id: Option<String>,
    is_deleted: bool,
}

impl ClipRecord {
    // å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºæ–°è®°å½•
    pub fn new(content: String, content_type: ContentType) -> AppResult<Self> {
        if content.is_empty() {
            return Err(AppError::EmptyContent);
        }

        let now = Local::now();
        let md5 = format!("{:x}", md5::compute(&content));

        Ok(Self {
            id: uuid::Uuid::new_v4().to_string(),
            content_type,
            content,
            md5,
            local_file_path: None,
            created_at: now,
            updated_at: now,
            sort: 0,
            is_pinned: false,
            sync_status: SyncStatus::NotSynced,
            device_id: None,
            is_deleted: false,
        })
    }

    // ä¸šåŠ¡è¡Œä¸ºï¼šç½®é¡¶
    pub fn pin(&mut self) {
        if !self.is_pinned {
            self.is_pinned = true;
            self.updated_at = Local::now();
        }
    }

    // ä¸šåŠ¡è¡Œä¸ºï¼šå–æ¶ˆç½®é¡¶
    pub fn unpin(&mut self) {
        if self.is_pinned {
            self.is_pinned = false;
            self.updated_at = Local::now();
        }
    }

    // ä¸šåŠ¡è¡Œä¸ºï¼šè½¯åˆ é™¤
    pub fn delete(&mut self) -> AppResult<()> {
        if self.is_deleted {
            return Err(AppError::AlreadyDeleted);
        }
        self.is_deleted = true;
        self.updated_at = Local::now();
        Ok(())
    }

    // ä¸šåŠ¡è§„åˆ™ï¼šæ˜¯å¦å¯ä»¥åŒæ­¥
    pub fn can_sync(&self) -> bool {
        !self.is_deleted && !matches!(self.sync_status, SyncStatus::Skip(_))
    }

    // ä¸šåŠ¡è¡Œä¸ºï¼šæ ‡è®°ä¸ºåŒæ­¥ä¸­
    pub fn mark_syncing(&mut self) {
        self.sync_status = SyncStatus::Syncing;
        self.updated_at = Local::now();
    }

    // ä¸šåŠ¡è¡Œä¸ºï¼šæ ‡è®°ä¸ºå·²åŒæ­¥
    pub fn mark_synced(&mut self) {
        self.sync_status = SyncStatus::Synced;
        self.updated_at = Local::now();
    }

    // Gettersï¼ˆåªè¯»è®¿é—®ï¼‰
    pub fn id(&self) -> &str { &self.id }
    pub fn content(&self) -> &str { &self.content }
    pub fn content_type(&self) -> &ContentType { &self.content_type }
    pub fn is_pinned(&self) -> bool { self.is_pinned }
    pub fn is_deleted(&self) -> bool { self.is_deleted }
    pub fn sync_status(&self) -> &SyncStatus { &self.sync_status }
    pub fn created_at(&self) -> DateTime<Local> { self.created_at }
}

// ç®€å•çš„å€¼å¯¹è±¡ï¼ˆæšä¸¾ï¼‰
#[derive(Debug, Clone, PartialEq)]
pub enum ContentType {
    Text,
    Image,
    File,
}

#[derive(Debug, Clone, PartialEq)]
pub enum SyncStatus {
    NotSynced,      // æœªåŒæ­¥
    Syncing,        // åŒæ­¥ä¸­
    Synced,         // å·²åŒæ­¥
    Skip(SkipReason), // è·³è¿‡åŒæ­¥
}

#[derive(Debug, Clone, PartialEq)]
pub enum SkipReason {
    Unsupported,    // ä¸æ”¯æŒçš„ç±»å‹
    VipRequired,    // éœ€è¦VIP
    TooLarge,       // æ–‡ä»¶å¤ªå¤§
}
```

**æ”¹è¿›æ•ˆæœï¼š**
- âœ… å°è£…å†…éƒ¨çŠ¶æ€ï¼Œå­—æ®µç§æœ‰åŒ–
- âœ… ä¸šåŠ¡é€»è¾‘åœ¨å®ä½“å†…éƒ¨ï¼ˆpinã€unpinã€deleteç­‰ï¼‰
- âœ… ä½¿ç”¨æšä¸¾æ›¿ä»£magic number
- âœ… ä½¿ç”¨å¼ºç±»å‹ï¼ˆDateTimeã€PathBufï¼‰
- âœ… è‡ªåŒ…å«éªŒè¯é€»è¾‘

### 4.2 æ”¹è¿›ç‚¹2ï¼šRepositoryæ¨¡å¼

#### Beforeï¼ˆç›´æ¥ä½¿ç”¨RBatisï¼‰

```rust
// âŒ å½“å‰ï¼šä¸šåŠ¡å±‚ç›´æ¥ä½¿ç”¨RBatis
pub async fn sync_clipboard() -> AppResult<()> {
    let rb: &RBatis = CONTEXT.get::<RBatis>();

    // ç›´æ¥æ‰§è¡ŒSQL
    let records = ClipRecord::select_all(rb).await?;

    for record in records {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

#### Afterï¼ˆRepositoryå±‚ï¼‰

```rust
// âœ… repository/clipboard_repo.rs
use std::sync::Arc;
use rbatis::RBatis;
use crate::domain::clipboard::ClipRecord;
use crate::shared::errors::AppResult;

pub struct ClipboardRepository {
    db: Arc<RBatis>,
}

impl ClipboardRepository {
    pub fn new(db: Arc<RBatis>) -> Self {
        Self { db }
    }

    // ä¿å­˜æˆ–æ›´æ–°è®°å½•
    pub async fn save(&self, record: &ClipRecord) -> AppResult<()> {
        let model = ClipRecordModel::from(record);

        let sql = "INSERT OR REPLACE INTO clip_record
                   (id, type, content, md5_str, created, is_pinned, sync_flag, ...)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ...)";

        self.db.exec(sql, vec![
            model.id,
            model.r#type,
            model.content,
            // ...
        ]).await?;

        Ok(())
    }

    // æ ¹æ®IDæŸ¥æ‰¾
    pub async fn find_by_id(&self, id: &str) -> AppResult<Option<ClipRecord>> {
        let sql = "SELECT * FROM clip_record WHERE id = ? AND del_flag = 0";
        let model: Option<ClipRecordModel> = self.db
            .fetch_by_column(sql, &[id])
            .await?;

        match model {
            Some(m) => Ok(Some(m.try_into()?)),
            None => Ok(None),
        }
    }

    // æŸ¥æ‰¾æœ€è¿‘çš„è®°å½•
    pub async fn find_recent(&self, limit: usize) -> AppResult<Vec<ClipRecord>> {
        let sql = "SELECT * FROM clip_record
                   WHERE del_flag = 0
                   ORDER BY sort DESC, created DESC
                   LIMIT ?";

        let models: Vec<ClipRecordModel> = self.db
            .fetch(sql, vec![limit])
            .await?;

        models.into_iter()
            .map(|m| m.try_into())
            .collect()
    }

    // æœç´¢è®°å½•
    pub async fn search(&self, keyword: &str, limit: usize) -> AppResult<Vec<ClipRecord>> {
        let sql = "SELECT * FROM clip_record
                   WHERE del_flag = 0 AND content LIKE ?
                   ORDER BY created DESC
                   LIMIT ?";

        let pattern = format!("%{}%", keyword);
        let models: Vec<ClipRecordModel> = self.db
            .fetch(sql, vec![pattern, limit])
            .await?;

        models.into_iter()
            .map(|m| m.try_into())
            .collect()
    }

    // æŸ¥æ‰¾ç½®é¡¶è®°å½•
    pub async fn find_pinned(&self) -> AppResult<Vec<ClipRecord>> {
        let sql = "SELECT * FROM clip_record
                   WHERE del_flag = 0 AND pinned_flag = 1
                   ORDER BY sort DESC";

        let models: Vec<ClipRecordModel> = self.db.fetch(sql, vec![]).await?;

        models.into_iter()
            .map(|m| m.try_into())
            .collect()
    }

    // æŸ¥æ‰¾éœ€è¦åŒæ­¥çš„è®°å½•
    pub async fn find_to_sync(&self, limit: usize) -> AppResult<Vec<ClipRecord>> {
        let sql = "SELECT * FROM clip_record
                   WHERE del_flag = 0 AND sync_flag = 0
                   ORDER BY created DESC
                   LIMIT ?";

        let models: Vec<ClipRecordModel> = self.db
            .fetch(sql, vec![limit])
            .await?;

        models.into_iter()
            .map(|m| m.try_into())
            .collect()
    }

    // åˆ é™¤è®°å½•
    pub async fn delete(&self, id: &str) -> AppResult<()> {
        let sql = "UPDATE clip_record SET del_flag = 1 WHERE id = ?";
        self.db.exec(sql, vec![id]).await?;
        Ok(())
    }

    // ç‰©ç†åˆ é™¤
    pub async fn hard_delete(&self, id: &str) -> AppResult<()> {
        let sql = "DELETE FROM clip_record WHERE id = ?";
        self.db.exec(sql, vec![id]).await?;
        Ok(())
    }
}

// æ•°æ®åº“æ¨¡å‹ï¼ˆä¸é¢†åŸŸæ¨¡å‹åˆ†ç¦»ï¼‰
#[derive(Debug, Clone, Serialize, Deserialize)]
struct ClipRecordModel {
    pub id: String,
    pub r#type: String,
    pub content: String,
    pub md5_str: String,
    pub created: i64,
    pub pinned_flag: i32,
    pub sync_flag: i32,
    // ...
}

// Domain Model â†’ DB Model
impl From<&ClipRecord> for ClipRecordModel {
    fn from(record: &ClipRecord) -> Self {
        Self {
            id: record.id().to_string(),
            r#type: record.content_type().to_string(),
            content: record.content().to_string(),
            md5_str: record.md5().to_string(),
            created: record.created_at().timestamp(),
            pinned_flag: if record.is_pinned() { 1 } else { 0 },
            sync_flag: record.sync_status().to_i32(),
            // ...
        }
    }
}

// DB Model â†’ Domain Model
impl TryFrom<ClipRecordModel> for ClipRecord {
    type Error = AppError;

    fn try_from(model: ClipRecordModel) -> AppResult<Self> {
        let content_type = ContentType::from_str(&model.r#type)?;
        let sync_status = SyncStatus::from_i32(model.sync_flag)?;

        Ok(ClipRecord::from_db(
            model.id,
            content_type,
            model.content,
            model.md5_str,
            // ...
        ))
    }
}
```

**æ”¹è¿›æ•ˆæœï¼š**
- âœ… æ•°æ®è®¿é—®é€»è¾‘é›†ä¸­åœ¨Repository
- âœ… é¢†åŸŸæ¨¡å‹ä¸æ•°æ®åº“æ¨¡å‹åˆ†ç¦»
- âœ… æ˜“äºæµ‹è¯•ï¼ˆå¯ä»¥Mock Repositoryï¼‰
- âœ… æ˜“äºåˆ‡æ¢æ•°æ®åº“å®ç°

### 4.3 æ”¹è¿›ç‚¹3ï¼šServiceå±‚

#### Beforeï¼ˆé€»è¾‘åˆ†æ•£ï¼‰

```rust
// âŒ å½“å‰ï¼šä¸šåŠ¡é€»è¾‘åˆ†æ•£åœ¨å„å¤„
// biz/clip_record.rs - ä¸€äº›é€»è¾‘
// biz/clip_record_sync.rs - ä¸€äº›é€»è¾‘
// biz/copy_clip_record.rs - ä¸€äº›é€»è¾‘
```

#### Afterï¼ˆServiceå±‚ï¼‰

```rust
// âœ… service/clipboard_service.rs
use std::sync::Arc;
use crate::domain::clipboard::{ClipRecord, ContentType};
use crate::repository::clipboard_repo::ClipboardRepository;
use crate::shared::errors::{AppError, AppResult};

pub struct ClipboardService {
    repo: Arc<ClipboardRepository>,
}

impl ClipboardService {
    pub fn new(repo: Arc<ClipboardRepository>) -> Self {
        Self { repo }
    }

    // ç”¨ä¾‹ï¼šä¿å­˜å‰ªè´´æ¿å†…å®¹
    pub async fn save_clipboard(
        &self,
        content: String,
        content_type: ContentType
    ) -> AppResult<ClipRecord> {
        // 1. åˆ›å»ºé¢†åŸŸå®ä½“ï¼ˆå¸¦éªŒè¯ï¼‰
        let record = ClipRecord::new(content, content_type)?;

        // 2. æŒä¹…åŒ–
        self.repo.save(&record).await?;

        // 3. è¿”å›ç»“æœ
        Ok(record)
    }

    // ç”¨ä¾‹ï¼šç½®é¡¶è®°å½•
    pub async fn pin_record(&self, id: &str) -> AppResult<()> {
        // 1. åŠ è½½å®ä½“
        let mut record = self.repo.find_by_id(id).await?
            .ok_or(AppError::RecordNotFound)?;

        // 2. è°ƒç”¨å®ä½“ä¸šåŠ¡æ–¹æ³•
        record.pin();

        // 3. ä¿å­˜
        self.repo.save(&record).await?;

        Ok(())
    }

    // ç”¨ä¾‹ï¼šå–æ¶ˆç½®é¡¶
    pub async fn unpin_record(&self, id: &str) -> AppResult<()> {
        let mut record = self.repo.find_by_id(id).await?
            .ok_or(AppError::RecordNotFound)?;

        record.unpin();

        self.repo.save(&record).await?;

        Ok(())
    }

    // ç”¨ä¾‹ï¼šåˆ é™¤è®°å½•
    pub async fn delete_record(&self, id: &str) -> AppResult<()> {
        let mut record = self.repo.find_by_id(id).await?
            .ok_or(AppError::RecordNotFound)?;

        record.delete()?;

        self.repo.save(&record).await?;

        Ok(())
    }

    // ç”¨ä¾‹ï¼šè·å–æœ€è¿‘è®°å½•
    pub async fn get_recent_records(&self, limit: usize) -> AppResult<Vec<ClipRecord>> {
        self.repo.find_recent(limit).await
    }

    // ç”¨ä¾‹ï¼šæœç´¢è®°å½•
    pub async fn search_records(&self, keyword: &str, limit: usize) -> AppResult<Vec<ClipRecord>> {
        if keyword.is_empty() {
            return Err(AppError::EmptyKeyword);
        }

        self.repo.search(keyword, limit).await
    }

    // ç”¨ä¾‹ï¼šè·å–ç½®é¡¶è®°å½•
    pub async fn get_pinned_records(&self) -> AppResult<Vec<ClipRecord>> {
        self.repo.find_pinned().await
    }
}
```

**æ”¹è¿›æ•ˆæœï¼š**
- âœ… ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨Serviceå±‚
- âœ… Serviceåªåšç”¨ä¾‹ç¼–æ’ï¼Œä¸åŒ…å«å®ä½“è¡Œä¸º
- âœ… æ¸…æ™°çš„æ–¹æ³•å‘½åï¼Œæ˜“äºç†è§£
- âœ… æ˜“äºæµ‹è¯•

### 4.4 æ”¹è¿›ç‚¹4ï¼šä¾èµ–æ³¨å…¥

#### Beforeï¼ˆå…¨å±€çŠ¶æ€ï¼‰

```rust
// âŒ å½“å‰ï¼šå…¨å±€CONTEXT
pub static CONTEXT: TypeMap![Send + Sync] = <TypeMap![Send + Sync]>::new();

// ä½¿ç”¨ï¼ˆéšå¼ä¾èµ–ï¼‰
let rb = CONTEXT.get::<RBatis>();
let app_handle = CONTEXT.get::<AppHandle>();
```

#### Afterï¼ˆä¾èµ–æ³¨å…¥ï¼‰

```rust
// âœ… lib.rs - åº”ç”¨çŠ¶æ€
use std::sync::Arc;
use rbatis::RBatis;

pub struct AppState {
    // åŸºç¡€è®¾æ–½
    db: Arc<RBatis>,

    // Repositories
    clipboard_repo: Arc<ClipboardRepository>,
    user_repo: Arc<UserRepository>,
    settings_repo: Arc<SettingsRepository>,

    // Services
    pub clipboard_service: Arc<ClipboardService>,
    pub sync_service: Arc<SyncService>,
    pub user_service: Arc<UserService>,
    pub vip_service: Arc<VipService>,
}

impl AppState {
    pub async fn new() -> AppResult<Self> {
        // 1. åˆå§‹åŒ–æ•°æ®åº“
        let db = Arc::new(init_database().await?);

        // 2. åˆ›å»ºRepositories
        let clipboard_repo = Arc::new(ClipboardRepository::new(db.clone()));
        let user_repo = Arc::new(UserRepository::new(db.clone()));
        let settings_repo = Arc::new(SettingsRepository::new(db.clone()));

        // 3. åˆ›å»ºServices
        let clipboard_service = Arc::new(ClipboardService::new(
            clipboard_repo.clone()
        ));

        let sync_service = Arc::new(SyncService::new(
            clipboard_repo.clone(),
            user_repo.clone()
        ));

        let user_service = Arc::new(UserService::new(
            user_repo.clone()
        ));

        let vip_service = Arc::new(VipService::new(
            user_repo.clone()
        ));

        Ok(Self {
            db,
            clipboard_repo,
            user_repo,
            settings_repo,
            clipboard_service,
            sync_service,
            user_service,
            vip_service,
        })
    }
}

// Tauriå¯åŠ¨
#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    tauri::Builder::default()
        .setup(|app| {
            // åˆå§‹åŒ–åº”ç”¨çŠ¶æ€
            let app_state = tauri::async_runtime::block_on(async {
                AppState::new().await.expect("Failed to initialize app state")
            });

            // æ³¨å†ŒçŠ¶æ€
            app.manage(app_state);

            Ok(())
        })
        .invoke_handler(tauri::generate_handler![
            commands::clipboard::save_clipboard,
            commands::clipboard::pin_record,
            // ...
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

**æ”¹è¿›æ•ˆæœï¼š**
- âœ… æ˜¾å¼ä¾èµ–å…³ç³»ï¼Œæ˜“äºè¿½è¸ª
- âœ… ä¾¿äºå•å…ƒæµ‹è¯•ï¼ˆå¯ä»¥æ³¨å…¥Mockï¼‰
- âœ… ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
- âœ… æ— å…¨å±€çŠ¶æ€ç«äº‰

### 4.5 æ”¹è¿›ç‚¹5ï¼šCommandså±‚

#### Beforeï¼ˆæ··ä¹±çš„Tauriå‘½ä»¤ï¼‰

```rust
// âŒ å½“å‰ï¼šå‘½ä»¤ä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘
#[tauri::command]
pub async fn pin_record(id: String) -> Result<(), String> {
    let rb = CONTEXT.get::<RBatis>();

    // ä¸šåŠ¡é€»è¾‘åœ¨å‘½ä»¤ä¸­
    ClipRecord::update_pinned(rb, &id, 1)
        .await
        .map_err(|e| e.to_string())
}
```

#### Afterï¼ˆCommandså±‚ï¼‰

```rust
// âœ… commands/clipboard.rs
use tauri::State;
use serde::{Deserialize, Serialize};
use crate::lib::AppState;
use crate::domain::clipboard::{ClipRecord, ContentType};

// DTOå®šä¹‰
#[derive(Deserialize)]
pub struct SaveClipboardRequest {
    pub content: String,
    pub content_type: String,
}

#[derive(Serialize)]
pub struct ClipboardRecordDto {
    pub id: String,
    pub content: String,
    pub content_type: String,
    pub created_at: String,
    pub is_pinned: bool,
    pub is_deleted: bool,
}

impl From<ClipRecord> for ClipboardRecordDto {
    fn from(record: ClipRecord) -> Self {
        Self {
            id: record.id().to_string(),
            content: record.content().to_string(),
            content_type: record.content_type().to_string(),
            created_at: record.created_at().to_rfc3339(),
            is_pinned: record.is_pinned(),
            is_deleted: record.is_deleted(),
        }
    }
}

// Tauri Commands
#[tauri::command]
pub async fn save_clipboard(
    request: SaveClipboardRequest,
    state: State<'_, AppState>
) -> Result<ClipboardRecordDto, String> {
    // 1. è§£æå†…å®¹ç±»å‹
    let content_type = ContentType::from_str(&request.content_type)
        .map_err(|e| e.to_string())?;

    // 2. è°ƒç”¨Service
    let record = state.clipboard_service
        .save_clipboard(request.content, content_type)
        .await
        .map_err(|e| e.to_string())?;

    // 3. è½¬æ¢ä¸ºDTO
    Ok(ClipboardRecordDto::from(record))
}

#[tauri::command]
pub async fn pin_record(
    id: String,
    state: State<'_, AppState>
) -> Result<(), String> {
    state.clipboard_service
        .pin_record(&id)
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn unpin_record(
    id: String,
    state: State<'_, AppState>
) -> Result<(), String> {
    state.clipboard_service
        .unpin_record(&id)
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn delete_record(
    id: String,
    state: State<'_, AppState>
) -> Result<(), String> {
    state.clipboard_service
        .delete_record(&id)
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
pub async fn get_recent_records(
    limit: usize,
    state: State<'_, AppState>
) -> Result<Vec<ClipboardRecordDto>, String> {
    let records = state.clipboard_service
        .get_recent_records(limit)
        .await
        .map_err(|e| e.to_string())?;

    let dtos = records.into_iter()
        .map(ClipboardRecordDto::from)
        .collect();

    Ok(dtos)
}

#[tauri::command]
pub async fn search_records(
    keyword: String,
    limit: usize,
    state: State<'_, AppState>
) -> Result<Vec<ClipboardRecordDto>, String> {
    let records = state.clipboard_service
        .search_records(&keyword, limit)
        .await
        .map_err(|e| e.to_string())?;

    let dtos = records.into_iter()
        .map(ClipboardRecordDto::from)
        .collect();

    Ok(dtos)
}
```

**æ”¹è¿›æ•ˆæœï¼š**
- âœ… Commandså±‚åªåšDTOè½¬æ¢å’Œè°ƒç”¨Service
- âœ… æ— ä¸šåŠ¡é€»è¾‘
- âœ… ä¾èµ–æ³¨å…¥State
- âœ… æ¸…æ™°çš„èŒè´£åˆ’åˆ†

---

## äº”ã€è¯¦ç»†è®¾è®¡

### 5.1 Domainå±‚è®¾è®¡

#### ClipRecordå®ä½“ï¼ˆå·²åœ¨4.1å±•ç¤ºï¼‰

#### Userå®ä½“

```rust
// domain/user.rs
use chrono::{DateTime, Local};

pub struct User {
    id: String,
    email: String,
    username: String,
    avatar_url: Option<String>,
    created_at: DateTime<Local>,
    updated_at: DateTime<Local>,
    is_vip: bool,
    vip_expires_at: Option<DateTime<Local>>,
}

impl User {
    // å·¥å‚æ–¹æ³•
    pub fn new(email: String, username: String) -> AppResult<Self> {
        if email.is_empty() || !email.contains('@') {
            return Err(AppError::InvalidEmail);
        }

        if username.is_empty() {
            return Err(AppError::EmptyUsername);
        }

        let now = Local::now();

        Ok(Self {
            id: uuid::Uuid::new_v4().to_string(),
            email,
            username,
            avatar_url: None,
            created_at: now,
            updated_at: now,
            is_vip: false,
            vip_expires_at: None,
        })
    }

    // ä¸šåŠ¡è¡Œä¸ºï¼šå‡çº§ä¸ºVIP
    pub fn upgrade_to_vip(&mut self, duration_days: i64) {
        self.is_vip = true;
        self.vip_expires_at = Some(Local::now() + chrono::Duration::days(duration_days));
        self.updated_at = Local::now();
    }

    // ä¸šåŠ¡è§„åˆ™ï¼šVIPæ˜¯å¦è¿‡æœŸ
    pub fn is_vip_active(&self) -> bool {
        if !self.is_vip {
            return false;
        }

        match self.vip_expires_at {
            Some(expires) => expires > Local::now(),
            None => false,
        }
    }

    // ä¸šåŠ¡è¡Œä¸ºï¼šæ›´æ–°ä¸ªäººèµ„æ–™
    pub fn update_profile(&mut self, username: String, avatar_url: Option<String>) -> AppResult<()> {
        if username.is_empty() {
            return Err(AppError::EmptyUsername);
        }

        self.username = username;
        self.avatar_url = avatar_url;
        self.updated_at = Local::now();

        Ok(())
    }

    // Getters
    pub fn id(&self) -> &str { &self.id }
    pub fn email(&self) -> &str { &self.email }
    pub fn username(&self) -> &str { &self.username }
    pub fn is_vip(&self) -> bool { self.is_vip }
}
```

#### VipMembershipå®ä½“

```rust
// domain/vip.rs
pub struct VipMembership {
    user_id: String,
    level: VipLevel,
    expires_at: DateTime<Local>,
    auto_renew: bool,
}

#[derive(Debug, Clone, PartialEq)]
pub enum VipLevel {
    Free,
    Basic,
    Premium,
}

impl VipLevel {
    // ä¸šåŠ¡è§„åˆ™ï¼šæƒç›Šæ£€æŸ¥
    pub fn can_cloud_sync(&self) -> bool {
        matches!(self, VipLevel::Basic | VipLevel::Premium)
    }

    pub fn max_storage_mb(&self) -> usize {
        match self {
            VipLevel::Free => 100,
            VipLevel::Basic => 1000,
            VipLevel::Premium => 10000,
        }
    }
}

impl VipMembership {
    pub fn is_active(&self) -> bool {
        self.expires_at > Local::now()
    }

    pub fn can_use_feature(&self, feature: VipFeature) -> bool {
        if !self.is_active() {
            return false;
        }

        match (self.level, feature) {
            (VipLevel::Free, VipFeature::BasicClipboard) => true,
            (VipLevel::Basic | VipLevel::Premium, VipFeature::CloudSync) => true,
            (VipLevel::Premium, VipFeature::UnlimitedDevices) => true,
            _ => false,
        }
    }
}

#[derive(Debug, Clone, PartialEq)]
pub enum VipFeature {
    BasicClipboard,
    CloudSync,
    UnlimitedDevices,
}
```

#### é€šç”¨ç±»å‹

```rust
// domain/types.rs
use chrono::{DateTime, Local};

// åŒæ­¥çŠ¶æ€
#[derive(Debug, Clone, PartialEq)]
pub enum SyncStatus {
    NotSynced,
    Syncing,
    Synced,
    Skip(SkipReason),
}

impl SyncStatus {
    pub fn to_i32(&self) -> i32 {
        match self {
            SyncStatus::NotSynced => 0,
            SyncStatus::Syncing => 1,
            SyncStatus::Synced => 2,
            SyncStatus::Skip(_) => 3,
        }
    }

    pub fn from_i32(value: i32) -> AppResult<Self> {
        match value {
            0 => Ok(SyncStatus::NotSynced),
            1 => Ok(SyncStatus::Syncing),
            2 => Ok(SyncStatus::Synced),
            3 => Ok(SyncStatus::Skip(SkipReason::Unsupported)),
            _ => Err(AppError::InvalidSyncStatus(value)),
        }
    }
}

#[derive(Debug, Clone, PartialEq)]
pub enum SkipReason {
    Unsupported,
    VipRequired,
    TooLarge,
}

// å†…å®¹ç±»å‹
#[derive(Debug, Clone, PartialEq)]
pub enum ContentType {
    Text,
    Image,
    File,
}

impl ContentType {
    pub fn from_str(s: &str) -> AppResult<Self> {
        match s.to_lowercase().as_str() {
            "text" => Ok(ContentType::Text),
            "image" => Ok(ContentType::Image),
            "file" => Ok(ContentType::File),
            _ => Err(AppError::InvalidContentType(s.to_string())),
        }
    }

    pub fn to_string(&self) -> String {
        match self {
            ContentType::Text => "text".to_string(),
            ContentType::Image => "image".to_string(),
            ContentType::File => "file".to_string(),
        }
    }
}
```

### 5.2 Repositoryå±‚è®¾è®¡

#### UserRepository

```rust
// repository/user_repo.rs
use std::sync::Arc;
use rbatis::RBatis;
use crate::domain::user::User;
use crate::shared::errors::AppResult;

pub struct UserRepository {
    db: Arc<RBatis>,
}

impl UserRepository {
    pub fn new(db: Arc<RBatis>) -> Self {
        Self { db }
    }

    pub async fn save(&self, user: &User) -> AppResult<()> {
        // å®ç°ä¿å­˜é€»è¾‘
        Ok(())
    }

    pub async fn find_by_id(&self, id: &str) -> AppResult<Option<User>> {
        // å®ç°æŸ¥æ‰¾é€»è¾‘
        Ok(None)
    }

    pub async fn find_by_email(&self, email: &str) -> AppResult<Option<User>> {
        // å®ç°æŸ¥æ‰¾é€»è¾‘
        Ok(None)
    }
}
```

### 5.3 Serviceå±‚è®¾è®¡

#### SyncServiceï¼ˆå¤æ‚ç”¨ä¾‹ï¼‰

```rust
// service/sync_service.rs
use std::sync::Arc;
use crate::domain::clipboard::ClipRecord;
use crate::repository::clipboard_repo::ClipboardRepository;
use crate::repository::user_repo::UserRepository;
use crate::api::cloud_sync_api::CloudSyncApi;
use crate::shared::errors::{AppError, AppResult};

pub struct SyncService {
    clipboard_repo: Arc<ClipboardRepository>,
    user_repo: Arc<UserRepository>,
    cloud_api: Arc<CloudSyncApi>,
}

impl SyncService {
    pub fn new(
        clipboard_repo: Arc<ClipboardRepository>,
        user_repo: Arc<UserRepository>,
        cloud_api: Arc<CloudSyncApi>
    ) -> Self {
        Self {
            clipboard_repo,
            user_repo,
            cloud_api,
        }
    }

    // ç”¨ä¾‹ï¼šåŒæ­¥åˆ°äº‘ç«¯
    pub async fn sync_to_cloud(&self, user_id: &str) -> AppResult<usize> {
        // 1. æ£€æŸ¥ç”¨æˆ·VIPæƒé™
        let user = self.user_repo.find_by_id(user_id).await?
            .ok_or(AppError::UserNotFound)?;

        if !user.is_vip_active() {
            return Err(AppError::VipRequired);
        }

        // 2. æŸ¥æ‰¾éœ€è¦åŒæ­¥çš„è®°å½•
        let records = self.clipboard_repo.find_to_sync(100).await?;

        let mut synced_count = 0;

        // 3. é€æ¡åŒæ­¥
        for mut record in records {
            if !record.can_sync() {
                continue;
            }

            // æ ‡è®°ä¸ºåŒæ­¥ä¸­
            record.mark_syncing();
            self.clipboard_repo.save(&record).await?;

            // ä¸Šä¼ åˆ°äº‘ç«¯
            match self.cloud_api.upload_record(&record).await {
                Ok(_) => {
                    record.mark_synced();
                    self.clipboard_repo.save(&record).await?;
                    synced_count += 1;
                }
                Err(e) => {
                    log::error!("Failed to sync record {}: {}", record.id(), e);
                    // æ¢å¤ä¸ºæœªåŒæ­¥çŠ¶æ€
                    // ...
                }
            }
        }

        Ok(synced_count)
    }

    // ç”¨ä¾‹ï¼šä»äº‘ç«¯åŒæ­¥
    pub async fn sync_from_cloud(&self, user_id: &str) -> AppResult<usize> {
        // å®ç°ä»äº‘ç«¯åŒæ­¥çš„é€»è¾‘
        Ok(0)
    }
}
```

### 5.4 é”™è¯¯å¤„ç†è®¾è®¡

```rust
// shared/errors.rs
use thiserror::Error;

#[derive(Error, Debug)]
pub enum AppError {
    // é¢†åŸŸé”™è¯¯ï¼ˆä¸šåŠ¡è§„åˆ™è¿åï¼‰
    #[error("å†…å®¹ä¸èƒ½ä¸ºç©º")]
    EmptyContent,

    #[error("æ— æ•ˆçš„é‚®ç®±æ ¼å¼")]
    InvalidEmail,

    #[error("è®°å½•ä¸å­˜åœ¨")]
    RecordNotFound,

    #[error("éœ€è¦VIPæƒé™")]
    VipRequired,

    #[error("è®°å½•å·²è¢«åˆ é™¤")]
    AlreadyDeleted,

    // åŸºç¡€è®¾æ–½é”™è¯¯
    #[error("æ•°æ®åº“é”™è¯¯: {0}")]
    Database(#[from] rbatis::Error),

    #[error("IOé”™è¯¯: {0}")]
    Io(#[from] std::io::Error),

    #[error("HTTPè¯·æ±‚é”™è¯¯: {0}")]
    Http(String),

    // å…¶ä»–é”™è¯¯
    #[error("æœªçŸ¥é”™è¯¯: {0}")]
    Unknown(String),
}

pub type AppResult<T> = Result<T, AppError>;
```

---

## å…­ã€å®æ–½è·¯çº¿å›¾

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰

#### Day 1-2ï¼šåˆ›å»ºæ–°ç›®å½•ç»“æ„

```bash
# åˆ›å»ºæ–°ç›®å½•
mkdir -p src-tauri/src/{domain,repository,service,commands}
mkdir -p src-tauri/src/infrastructure
mkdir -p src-tauri/src/shared

# ç§»åŠ¨æ—§ä»£ç 
mv src-tauri/src/biz src-tauri/src/legacy/biz
```

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] åˆ›å»ºå®Œæ•´çš„ç›®å½•ç»“æ„
- [ ] è®¾ç½®æ¨¡å—å¯¼å‡ºï¼ˆmod.rsæ–‡ä»¶ï¼‰
- [ ] ç§»åŠ¨æ—§ä»£ç åˆ°legacy/
- [ ] ç¡®ä¿é¡¹ç›®ä»å¯ç¼–è¯‘

#### Day 3-4ï¼šå®ç°Domainå±‚åŸºç¡€

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç° `domain/clipboard.rs` - ClipRecordå®ä½“ï¼ˆå……è¡€æ¨¡å‹ï¼‰
- [ ] å®ç° `domain/types.rs` - é€šç”¨æšä¸¾ç±»å‹
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¡®ä¿ç¼–è¯‘é€šè¿‡

**ç¤ºä¾‹ä»£ç ï¼š** è§4.1èŠ‚

#### Day 5-7ï¼šå®ç°Repositoryå±‚

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç° `repository/clipboard_repo.rs`
- [ ] å®ç°æ•°æ®åº“æ¨¡å‹è½¬æ¢ï¼ˆClipRecordModelï¼‰
- [ ] ä»legacy/bizä¸­è¿ç§»SQLæŸ¥è¯¢é€»è¾‘
- [ ] ç¼–å†™Repositoryå•å…ƒæµ‹è¯•

**è¿ç§»ç­–ç•¥ï¼š**
```rust
// ä» legacy/biz/clip_record.rs è¿ç§»
// æŠŠæ‰€æœ‰ ClipRecord::select_xxx æ–¹æ³•
// è¿ç§»åˆ° ClipboardRepository::find_xxx æ–¹æ³•
```

### é˜¶æ®µäºŒï¼šä¸šåŠ¡é€»è¾‘è¿ç§»ï¼ˆç¬¬2å‘¨ï¼‰

#### Day 8-10ï¼šå®ç°Serviceå±‚

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç° `service/clipboard_service.rs`
- [ ] ä»legacy/bizè¿ç§»ä¸šåŠ¡é€»è¾‘åˆ°Service
- [ ] è°ƒæ•´ä¸šåŠ¡é€»è¾‘è°ƒç”¨å®ä½“æ–¹æ³•
- [ ] ç¼–å†™Serviceé›†æˆæµ‹è¯•

**è¿ç§»å¯¹ç…§è¡¨ï¼š**

| æ—§ä»£ç  | æ–°ä»£ç  |
|--------|--------|
| `legacy/biz/clip_record.rs::update_pinned` | `ClipRecord::pin` + `ClipboardService::pin_record` |
| `legacy/biz/clip_record.rs::update_content` | `ClipRecord` å®ä¾‹æ–¹æ³• + Service |
| `legacy/biz/copy_clip_record.rs` | `ClipboardService::save_clipboard` |

#### Day 11-12ï¼šå®ç°Commandså±‚

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç° `commands/clipboard.rs`
- [ ] å®šä¹‰DTOç»“æ„
- [ ] å®ç°DTOè½¬æ¢é€»è¾‘
- [ ] æ›´æ–°Tauriå‘½ä»¤æ³¨å†Œ

#### Day 13-14ï¼šä¾èµ–æ³¨å…¥é‡æ„

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] åœ¨ `lib.rs` ä¸­å®ç°AppState
- [ ] é…ç½®ä¾èµ–æ³¨å…¥
- [ ] ç§»é™¤CONTEXTçš„ä½¿ç”¨
- [ ] æ›´æ–°æ‰€æœ‰å‘½ä»¤ä½¿ç”¨Stateæ³¨å…¥
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

### é˜¶æ®µä¸‰ï¼šå…¶ä»–æ¨¡å—è¿ç§»ï¼ˆç¬¬3å‘¨ï¼‰

#### Day 15-16ï¼šUseræ¨¡å—

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç° `domain/user.rs`
- [ ] å®ç° `repository/user_repo.rs`
- [ ] å®ç° `service/user_service.rs`
- [ ] å®ç° `commands/user.rs`
- [ ] è¿ç§» `legacy/biz/user_auth.rs`

#### Day 17-18ï¼šVIPæ¨¡å—

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç° `domain/vip.rs`
- [ ] å®ç° `service/vip_service.rs`
- [ ] è¿ç§» `legacy/biz/vip_checker.rs`
- [ ] è¿ç§» `legacy/biz/vip_management.rs`

#### Day 19-20ï¼šSyncæ¨¡å—

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] å®ç° `service/sync_service.rs`
- [ ] è¿ç§» `legacy/biz/cloud_sync_timer.rs`
- [ ] è¿ç§» `legacy/biz/upload_cloud_timer.rs`
- [ ] è¿ç§» `legacy/biz/download_cloud_file.rs`

#### Day 21ï¼šæ¸…ç†å’Œä¼˜åŒ–

**ä»»åŠ¡æ¸…å•ï¼š**
- [ ] åˆ é™¤legacy/ç›®å½•ï¼ˆç¡®ä¿æ‰€æœ‰åŠŸèƒ½å·²è¿ç§»ï¼‰
- [ ] ä»£ç review
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°

### è¿ç§»æ£€æŸ¥æ¸…å•

æ¯ä¸ªæ¨¡å—è¿ç§»å®Œæˆåæ£€æŸ¥ï¼š

```markdown
## Clipboardæ¨¡å—è¿ç§»æ£€æŸ¥æ¸…å•

- [ ] Domainå±‚
  - [ ] ClipRecordå®ä½“å®Œæˆ
  - [ ] æ‰€æœ‰å­—æ®µç§æœ‰åŒ–
  - [ ] å®ç°ä¸šåŠ¡è¡Œä¸ºæ–¹æ³•
  - [ ] å•å…ƒæµ‹è¯•é€šè¿‡

- [ ] Repositoryå±‚
  - [ ] ClipboardRepositoryå®Œæˆ
  - [ ] æ‰€æœ‰CRUDæ–¹æ³•å®ç°
  - [ ] æ•°æ®åº“æ¨¡å‹è½¬æ¢å®Œæˆ
  - [ ] Repositoryæµ‹è¯•é€šè¿‡

- [ ] Serviceå±‚
  - [ ] ClipboardServiceå®Œæˆ
  - [ ] æ‰€æœ‰ç”¨ä¾‹å®ç°
  - [ ] é›†æˆæµ‹è¯•é€šè¿‡

- [ ] Commandså±‚
  - [ ] æ‰€æœ‰Tauriå‘½ä»¤å®ç°
  - [ ] DTOå®šä¹‰å®Œæˆ
  - [ ] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡

- [ ] åŠŸèƒ½éªŒè¯
  - [ ] å‰ç«¯åŠŸèƒ½æ­£å¸¸
  - [ ] æ€§èƒ½æ— é€€åŒ–
  - [ ] æ— æ–°å¢bug
```

---

## ä¸ƒã€æ–¹æ¡ˆå¯¹æ¯”

### 7.1 ä¸å®Œæ•´DDDæ–¹æ¡ˆå¯¹æ¯”

| å¯¹æ¯”é¡¹ | å®Œæ•´DDDæ–¹æ¡ˆ | æœ¬è½»é‡çº§æ–¹æ¡ˆ | å½“å‰æ¶æ„ |
|--------|------------|-------------|---------|
| **æ¶æ„å¤æ‚åº¦** | â­â­â­â­â­ éå¸¸å¤æ‚ | â­â­â­ ä¸­ç­‰ | â­â­ ç®€å• |
| **ä»£ç å¢é‡** | +70% | +30% | åŸºçº¿ |
| **å­¦ä¹ æ›²çº¿** | é™¡å³­ | å¹³ç¼“ | æ—  |
| **å¼€å‘é€Ÿåº¦** | æ…¢ï¼ˆå‰æœŸï¼‰ | ä¸­ç­‰ | å¿« |
| **å®æ–½æ—¶é—´** | 1-2ä¸ªæœˆ | 2-3å‘¨ | - |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â­ | â­â­â­â­ | â­â­ |
| **å¯æµ‹è¯•æ€§** | â­â­â­â­â­ | â­â­â­â­ | â­â­ |
| **çµæ´»æ€§** | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **é€‚åˆè§„æ¨¡** | å¤§å‹ï¼ˆ100k+è¡Œï¼‰ | ä¸­å°å‹ï¼ˆ10k-50kè¡Œï¼‰ | å°å‹ï¼ˆ<10kè¡Œï¼‰ |

### 7.2 è¯¦ç»†å¯¹æ¯”

#### ç›®å½•ç»“æ„å¯¹æ¯”

| å®Œæ•´DDD | è½»é‡çº§æ–¹æ¡ˆ | è¯´æ˜ |
|---------|-----------|------|
| domain/entities/ | domain/ | åˆå¹¶å®ä½“å’Œå€¼å¯¹è±¡ |
| domain/value_objects/ | domain/types.rs | ç”¨æšä¸¾ä»£æ›¿å¤æ‚å€¼å¯¹è±¡ |
| domain/repositories/ (æ¥å£) | repository/ | çœç•¥æ¥å£å®šä¹‰ |
| domain/services/ | - | é€»è¾‘æ”¾åˆ°å®ä½“æˆ–Serviceå±‚ |
| application/services/ | service/ | åˆå¹¶åº”ç”¨æœåŠ¡ |
| application/dto/ | commands/ (å†…è”DTO) | DTOå®šä¹‰åœ¨Commandsä¸­ |
| infrastructure/persistence/repositories/ | repository/ | ç®€åŒ–ç›®å½•å±‚çº§ |
| infrastructure/persistence/models/ | repository/ (å†…è”) | æ¨¡å‹å®šä¹‰åœ¨Repositoryä¸­ |
| interfaces/commands/ | commands/ | ç›´æ¥ä½¿ç”¨commands/ |

**ä»£ç æ–‡ä»¶æ•°å¯¹æ¯”ï¼ˆClipboardæ¨¡å—ï¼‰ï¼š**
- å®Œæ•´DDDï¼š15ä¸ªæ–‡ä»¶
- è½»é‡çº§æ–¹æ¡ˆï¼š6ä¸ªæ–‡ä»¶
- å½“å‰æ¶æ„ï¼š4ä¸ªæ–‡ä»¶

#### ä»£ç é‡å¯¹æ¯”ï¼ˆä»¥Clipboardæ¨¡å—ä¸ºä¾‹ï¼‰

| å®Œæ•´DDD | è½»é‡çº§æ–¹æ¡ˆ | å½“å‰æ¶æ„ |
|---------|-----------|---------|
| domain/clipboard/entities/clipboard_record.rs (300è¡Œ) | domain/clipboard.rs (200è¡Œ) | biz/clip_record.rs (598è¡Œ) |
| domain/clipboard/value_objects/ (3ä¸ªæ–‡ä»¶ï¼Œ200è¡Œ) | domain/types.rs (50è¡Œ) | - |
| domain/clipboard/repositories/clipboard_repository.rs (100è¡Œ) | - | - |
| infrastructure/.../clipboard_repository_impl.rs (400è¡Œ) | repository/clipboard_repo.rs (300è¡Œ) | - |
| infrastructure/.../clipboard_model.rs (200è¡Œ) | (å†…è”åœ¨repoä¸­) | - |
| application/services/clipboard_service.rs (300è¡Œ) | service/clipboard_service.rs (200è¡Œ) | åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ |
| interfaces/commands/clipboard_commands.rs (200è¡Œ) | commands/clipboard.rs (150è¡Œ) | æ··åœ¨ä¸€èµ· |
| interfaces/dto/ (3ä¸ªæ–‡ä»¶ï¼Œ200è¡Œ) | (å†…è”åœ¨commandsä¸­) | - |
| **æ€»è®¡ï¼šçº¦1900è¡Œ** | **æ€»è®¡ï¼šçº¦900è¡Œ** | **å½“å‰ï¼šçº¦1000è¡Œ** |

**ç»“è®ºï¼š**
- å®Œæ•´DDDå¢åŠ 90%ä»£ç é‡
- è½»é‡çº§æ–¹æ¡ˆå‡å°‘10%ä»£ç é‡ï¼ˆé€šè¿‡å»é™¤å†—ä½™ï¼‰

### 7.3 ä¼˜ç¼ºç‚¹å¯¹æ¯”

#### å®Œæ•´DDDæ–¹æ¡ˆ

**ä¼˜ç‚¹ï¼š**
- âœ… ç†è®ºä¸Šæœ€ä¼˜çš„æ¶æ„
- âœ… ç¬¦åˆæ‰€æœ‰æœ€ä½³å®è·µ
- âœ… æé«˜çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§
- âœ… é€‚åˆå¤§å‹å¤æ‚ç³»ç»Ÿ

**ç¼ºç‚¹ï¼š**
- âŒ è¿‡åº¦è®¾è®¡ï¼ˆå¯¹å½“å‰é¡¹ç›®ï¼‰
- âŒ å¤§é‡æ ·æ¿ä»£ç 
- âŒ å­¦ä¹ æ›²çº¿é™¡å³­
- âŒ å¼€å‘é€Ÿåº¦æ…¢
- âŒ ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½éœ€è¦æ”¹6-8ä¸ªæ–‡ä»¶

#### è½»é‡çº§æ–¹æ¡ˆ

**ä¼˜ç‚¹ï¼š**
- âœ… è§£å†³æ ¸å¿ƒé—®é¢˜ï¼ˆè´«è¡€æ¨¡å‹ã€å…¨å±€çŠ¶æ€ã€é«˜è€¦åˆï¼‰
- âœ… ä»£ç é‡å¯æ§
- âœ… å­¦ä¹ æ›²çº¿å¹³ç¼“
- âœ… å®æ–½å‘¨æœŸçŸ­
- âœ… ä¿æŒçµæ´»æ€§

**ç¼ºç‚¹ï¼š**
- âš ï¸ æ²¡æœ‰å®Œæ•´DDDé‚£ä¹ˆ"ä¼˜é›…"
- âš ï¸ Repositoryæ²¡æœ‰æ¥å£æŠ½è±¡ï¼ˆä½†å¯¹å°é¡¹ç›®è¶³å¤Ÿï¼‰
- âš ï¸ å€¼å¯¹è±¡ç”¨æšä¸¾ä»£æ›¿ï¼ˆæŸå¤±ä¸€äº›ç±»å‹å®‰å…¨ï¼‰

#### å½“å‰æ¶æ„

**ä¼˜ç‚¹ï¼š**
- âœ… ç®€å•ç›´æ¥
- âœ… å¼€å‘é€Ÿåº¦å¿«

**ç¼ºç‚¹ï¼š**
- âŒ è´«è¡€æ¨¡å‹
- âŒ å…¨å±€çŠ¶æ€æ³›æ»¥
- âŒ éš¾ä»¥æµ‹è¯•
- âŒ é«˜è€¦åˆ
- âŒ éšç€åŠŸèƒ½å¢åŠ ä¼šè¶Šæ¥è¶Šéš¾ç»´æŠ¤

---

## å…«ã€é£é™©ä¸åº”å¯¹

### 8.1 é£é™©è¯†åˆ«

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹ç­–ç•¥ |
|-----|--------|------|---------|
| **è¿ç§»è¿‡ç¨‹ä¸­å¼•å…¥bug** | é«˜ | é«˜ | æ¯ä¸ªé˜¶æ®µå……åˆ†æµ‹è¯•ï¼›ä¿ç•™æ—§ä»£ç å¯¹ç…§ |
| **æ€§èƒ½é€€åŒ–** | ä¸­ | é«˜ | æ€§èƒ½æµ‹è¯•å¯¹æ¯”ï¼›å…³é”®è·¯å¾„ä¼˜åŒ– |
| **å®æ–½æ—¶é—´è¶…å‡ºé¢„æœŸ** | ä¸­ | ä¸­ | åˆ†é˜¶æ®µå®æ–½ï¼›ä¼˜å…ˆæ ¸å¿ƒæ¨¡å— |
| **å›¢é˜Ÿä¸é€‚åº”æ–°æ¶æ„** | ä½ | ä¸­ | ç¼–å†™è¯¦ç»†æ–‡æ¡£ï¼›ä»£ç review |
| **æ—§ä»£ç ä¾èµ–éš¾ä»¥è§£è€¦** | ä¸­ | ä¸­ | æ¸è¿›å¼è¿ç§»ï¼›ä¿ç•™é€‚é…å±‚ |

### 8.2 å›é€€ç­–ç•¥

å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­å‡ºç°é‡å¤§é—®é¢˜ï¼š

**é˜¶æ®µä¸€å¤±è´¥ï¼š**
- åˆ é™¤æ–°ä»£ç 
- æ¢å¤legacy/ç›®å½•åˆ°åŸä½ç½®
- æŸå¤±ï¼š1å‘¨å¼€å‘æ—¶é—´

**é˜¶æ®µäºŒå¤±è´¥ï¼š**
- ä¿ç•™Domainå’ŒRepositoryå±‚
- å›é€€Serviceå’ŒCommands
- æŸå¤±ï¼š2å‘¨å¼€å‘æ—¶é—´

**é˜¶æ®µä¸‰å¤±è´¥ï¼š**
- ä¿ç•™å·²è¿ç§»æ¨¡å—
- æš‚åœå…¶ä»–æ¨¡å—è¿ç§»
- æ–°æ—§ä»£ç å…±å­˜

### 8.3 è´¨é‡ä¿è¯

#### æµ‹è¯•ç­–ç•¥

```rust
// 1. å•å…ƒæµ‹è¯•ï¼ˆDomainå±‚ï¼‰
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_clip_record_pin() {
        let mut record = ClipRecord::new(
            "test".to_string(),
            ContentType::Text
        ).unwrap();

        assert!(!record.is_pinned());
        record.pin();
        assert!(record.is_pinned());
    }
}

// 2. é›†æˆæµ‹è¯•ï¼ˆRepositoryå±‚ï¼‰
#[tokio::test]
async fn test_clipboard_repo_save_and_find() {
    let db = setup_test_db().await;
    let repo = ClipboardRepository::new(db);

    let record = ClipRecord::new("test".to_string(), ContentType::Text).unwrap();
    repo.save(&record).await.unwrap();

    let found = repo.find_by_id(record.id()).await.unwrap();
    assert!(found.is_some());
}

// 3. ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆCommandså±‚ï¼‰
// ä½¿ç”¨Tauriçš„æµ‹è¯•å·¥å…·
```

#### æ€§èƒ½æµ‹è¯•

```rust
// è¿ç§»å‰åæ€§èƒ½å¯¹æ¯”
#[bench]
fn bench_save_clipboard_old(b: &mut Bencher) {
    // æµ‹è¯•æ—§ä»£ç 
}

#[bench]
fn bench_save_clipboard_new(b: &mut Bencher) {
    // æµ‹è¯•æ–°ä»£ç 
}
```

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- ä¿å­˜å‰ªè´´æ¿ï¼š< 10ms
- æŸ¥è¯¢æœ€è¿‘è®°å½•ï¼š< 50ms
- æœç´¢ï¼š< 100ms

---

## ä¹ã€æ€»ç»“

### 9.1 ä¸ºä»€ä¹ˆé€‰æ‹©è½»é‡çº§æ–¹æ¡ˆï¼Ÿ

1. **é€‚åˆé¡¹ç›®è§„æ¨¡** - ClipPalæ˜¯ä¸­å°å‹é¡¹ç›®ï¼Œå®Œæ•´DDDè¿‡äºå¤æ‚
2. **å¿«é€Ÿè§æ•ˆ** - 2-3å‘¨å³å¯å®Œæˆï¼Œè€Œé1-2ä¸ªæœˆ
3. **å­¦ä¹ æ›²çº¿å¹³ç¼“** - å›¢é˜Ÿå®¹æ˜“ä¸Šæ‰‹
4. **æˆæœ¬å¯æ§** - ä»£ç é‡å¢åŠ 30%ï¼Œå¯æ¥å—
5. **è§£å†³æ ¸å¿ƒé—®é¢˜** - è´«è¡€æ¨¡å‹ã€å…¨å±€çŠ¶æ€ã€é«˜è€¦åˆéƒ½å¾—åˆ°è§£å†³

### 9.2 é¢„æœŸæ”¶ç›Š

| æ”¹è¿›é¡¹ | æ”¹å–„ç¨‹åº¦ |
|--------|---------|
| **ä»£ç å¯ç»´æŠ¤æ€§** | æå‡100% |
| **å¯æµ‹è¯•æ€§** | æå‡150% |
| **æ¨¡å—è€¦åˆåº¦** | é™ä½60% |
| **å¼€å‘æ•ˆç‡** | å‰æœŸé™ä½20%ï¼ŒåæœŸæå‡40% |
| **Bugç‡** | é™ä½30% |

### 9.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **å†³ç­–** - ç¡®è®¤é‡‡ç”¨æœ¬æ–¹æ¡ˆ
2. âœ… **å‡†å¤‡** - åˆ›å»ºåˆ†æ”¯ï¼Œå¤‡ä»½ä»£ç 
3. âœ… **å¯åŠ¨** - æŒ‰ç…§é˜¶æ®µä¸€å¼€å§‹å®æ–½
4. âœ… **è¿­ä»£** - æ¯å‘¨reviewè¿›åº¦
5. âœ… **å®Œæˆ** - 3å‘¨åäº¤ä»˜æ–°æ¶æ„

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

1. **æ¶æ„è®¾è®¡**
   - ã€Šæ•´æ´æ¶æ„ã€‹ - Robert C. Martin
   - ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹ - Eric Evansï¼ˆå‚è€ƒæ€æƒ³ï¼Œä¸å®Œå…¨ç…§æ¬ï¼‰
   - ã€Šé‡æ„ï¼šæ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹ - Martin Fowler

2. **Rustæœ€ä½³å®è·µ**
   - [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/)
   - [Rust Design Patterns](https://rust-unofficial.github.io/patterns/)

3. **Tauriæ–‡æ¡£**
   - [Tauri Guide](https://tauri.app/guide/)
   - [Tauri State Management](https://tauri.app/concepts/state-management/)

### B. å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆä¸ç”¨traitå®šä¹‰Repositoryæ¥å£ï¼Ÿ**
A: å¯¹å°é¡¹ç›®æ¥è¯´ï¼Œå…·ä½“å®ç°å°±è¶³å¤Ÿäº†ã€‚å¦‚æœæœªæ¥éœ€è¦Mockæµ‹è¯•ï¼Œå¯ä»¥åç»­æ·»åŠ ã€‚

**Q: ä¸ºä»€ä¹ˆå€¼å¯¹è±¡ç”¨æšä¸¾è€Œä¸æ˜¯structï¼Ÿ**
A: æšä¸¾æ›´ç®€å•ï¼Œå¯¹å¤§å¤šæ•°åœºæ™¯è¶³å¤Ÿã€‚åªæœ‰å¤æ‚éªŒè¯é€»è¾‘æ‰éœ€è¦structã€‚

**Q: å¦‚ä½•å¤„ç†å¼‚æ­¥ä¾èµ–ï¼Ÿ**
A: ä½¿ç”¨ArcåŒ…è£…ï¼Œé€šè¿‡Stateæ³¨å…¥åˆ°commandsã€‚

**Q: æ—§ä»£ç ä½•æ—¶åˆ é™¤ï¼Ÿ**
A: æ‰€æœ‰åŠŸèƒ½è¿ç§»å®Œæˆå¹¶æµ‹è¯•é€šè¿‡åï¼Œç»Ÿä¸€åˆ é™¤legacy/ç›®å½•ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-12-02
**ä½œè€…**: ClipPal Team
**çŠ¶æ€**: å¾…è¯„å®¡

